# (manual; next step)
#
# Sanity checks (manual verification):
# 1. Run ci-packs.yml on a PR that touches a candidate pack and check:
#    - packs-ci-artifacts/index_docs.json is non-empty
#    - packs-ci-artifacts/eval_report.json is generated by offline_eval.py
# 2. Run Promote Pack with packs = "psg@1.0.X" (or psg@1.0.X,edg@1.0.Y)
#    - Confirm promote-artifacts/index_docs.json has docs only for those packs
#    - Confirm promote-artifacts/eval_report.json no longer contains old TEST-pack Mac path,
#      but new entries generated during this workflow
#    - Confirm wire_check.py output logs <PACK@VERSION>: <non-zero> docs for each promoted pack

name: Promote Pack
on:
  workflow_dispatch:
    inputs:
      packs:
        description: "Comma-separated packs, e.g. psg@1.0.0,edg@1.0.1"
        required: true
        type: string

permissions:
  contents: read

jobs:
  promote:
    runs-on: ubuntu-latest
    environment: dev   # <â€” protect this env with required reviewers
    env:
      AZURE_SEARCH_ENDPOINT: https://sgdev-search-01.search.windows.net
      AZURE_SEARCH_INDEX: smartai-prompts-v2
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.10" }   # match App Service
      - run: pip install -r requirements.txt
      - name: Validate packs input
        run: |
          if [ -z "${{ inputs.packs }}" ]; then
            echo "packs input is required"; exit 1
          fi
      - name: Normalise pack input to uppercase
        run: |
          echo "PACKS=$(echo '${{ inputs.packs }}' | tr '[:lower:]' '[:upper:]')" >> $GITHUB_ENV
      - name: Build approved payload
        run: python tools/build_index_payload.py --status approved --packs "$PACKS" --out artifacts/index_docs.json
      - name: Index to Azure Search
        env:
          AZURE_SEARCH_ADMIN_KEY: ${{ secrets.AZURE_SEARCH_ADMIN_KEY }}
        run: python tools/index_packs.py --in artifacts/index_docs.json
      - name: Wire-check
        env:
          AZURE_SEARCH_QUERY_KEY: ${{ secrets.AZURE_SEARCH_QUERY_KEY }}
        run: python tools/wire_check.py --packs "$PACKS"
      - name: Offline eval (goldens proxy)
        run: |
          python tools/offline_eval.py \
            --vault app/vault \
            --goldens "app/vault/**/golden/*.jsonl" \
            --min_grounded 0.80 \
            --max_chars 12000 \
            --out artifacts/eval_report.json \
            --dry-worker
      - name: Upload promote artifacts
        uses: actions/upload-artifact@v4
        with:
          name: promote-artifacts
          path: artifacts/

